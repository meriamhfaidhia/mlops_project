pipeline {
    agent any

    environment {
        PROJECT_DIR = "${WORKSPACE}"  // Utilisation du workspace Jenkins
        MODEL_PATH = "${PROJECT_DIR}/prediction_model.joblib"
    }

    stages {
        stage('Download Repository') {
            steps {
                script {
                    echo "üì• T√©l√©chargement du d√©p√¥t en tant qu'archive ZIP..."
                    sh """
                        # T√©l√©chargement de l'archive ZIP du d√©p√¥t
                        curl -L https://github.com/meriamhfaidhia/mlops_project/archive/refs/heads/main.zip -o ${PROJECT_DIR}/mlops_project.zip
                        
                        # Extraction de l'archive ZIP
                        unzip ${PROJECT_DIR}/mlops_project.zip -d ${PROJECT_DIR}
                        
                        # Renommer le dossier extrait pour correspondre √† la structure du projet
                        mv ${PROJECT_DIR}/mlops_project-main ${PROJECT_DIR}/mlops_project
                    """
                }
            }
        }

        stage('Setup Virtual Environment') {
            steps {
                script {
                    echo "üîÑ Installation des d√©pendances..."
                    sh """
                        set -e
                        cd ${PROJECT_DIR}/mlops_project
                        python3 -m venv venv
                        . venv/bin/activate
                        pip install -r requirements.txt
                    """
                }
            }
        }

        stage('Code Linting') {
            steps {
                script {
                    echo "üîç V√©rification du style de code avec Flake8..."
                    sh """
                        set -e
                        cd ${PROJECT_DIR}/mlops_project
                        . venv/bin/activate
                        flake8 main.py model_pipeline.py --count --show-source --statistics
                    """
                }
            }
        }

        stage('Run Unit Tests') {
            steps {
                script {
                    echo "üß™ Ex√©cution des tests unitaires..."
                    sh """
                        set -e
                        cd ${PROJECT_DIR}/mlops_project
                        . venv/bin/activate
                        pytest tests/ --maxfail=1 --disable-warnings -q
                    """
                }
            }
        }

        stage('Train Model') {
            steps {
                script {
                    echo "üöÄ Entra√Ænement du mod√®le..."
                    sh """
                        set -e
                        cd ${PROJECT_DIR}/mlops_project
                        . venv/bin/activate
                        python3 main.py --train --train_path churn-bigml-20.csv --test_path churn-bigml-80.csv
                    """
                }
            }
        }

        stage('Evaluate Model') {
            steps {
                script {
                    echo "üìä √âvaluation du mod√®le..."
                    sh """
                        set -e
                        cd ${PROJECT_DIR}/mlops_project
                        . venv/bin/activate
                        python3 main.py --evaluate --train_path churn-bigml-20.csv --test_path churn-bigml-80.csv
                    """
                }
            }
        }

        stage('Save Model') {
            steps {
                script {
                    echo "üíæ Sauvegarde du mod√®le..."
                    sh """
                        set -e
                        cd ${PROJECT_DIR}/mlops_project
                        . venv/bin/activate
                        python3 main.py --save ${MODEL_PATH} --train_path churn-bigml-20.csv --test_path churn-bigml-80.csv
                    """
                }
            }
        }

        stage('Deploy API') {
            steps {
                script {
                    echo "üöÄ Lancement de l'API FastAPI..."
                    sh "bash ${PROJECT_DIR}/mlops_project/start_api.sh"
                }
            }
        }

        stage('Test API') {
            steps {
                script {
                    echo "‚úîÔ∏è Test de l'API via Swagger..."
                    sh """
                        set -e
                        curl --retry 10 --retry-delay 5 --fail http://192.168.93.6:8000/docs
                        curl --retry 10 --retry-delay 5 --fail http://192.168.93.6:8000/predict -X POST -H "Content-Type: application/json" -d '{"data": [0.1, 0.2, 0.3]}'
                    """
                }
            }
        }

        stage('Stop API') {
            steps {
                script {
                    echo "üõë Arr√™t de l'API FastAPI..."
                    sh "bash ${PROJECT_DIR}/mlops_project/stop_api.sh"
                }
            }
        }
    }

    post {
        always {
            echo "üîß Nettoyage ou actions post-ex√©cution"
            sh "rm -rf ${PROJECT_DIR}/mlops_project/venv"
        }
        success {
            echo "‚úÖ Pipeline ex√©cut√© avec succ√®s!"
        }
        failure {
            echo "‚ùå Pipeline √©chou√©."
        }
    }
}

